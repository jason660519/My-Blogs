<!DOCTYPE html>
<html lang="tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章路由處理</title>
    <script>
        // 瀏覽器語言檢測函數
        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            
            // 語言映射規則
            const languageMap = {
                'zh-TW': 'tw',
                'zh-Hant': 'tw',
                'zh-CN': 'cn',
                'zh-Hans': 'cn',
                'ja': 'jp',
                'ja-JP': 'jp'
            };
            
            // 檢查完整語言代碼
            if (languageMap[browserLang]) {
                return languageMap[browserLang];
            }
            
            // 檢查語言前綴
            const langPrefix = browserLang.split('-')[0];
            if (langPrefix === 'zh') {
                // 如果是中文但沒有明確區域，預設為正體中文
                return 'tw';
            } else if (langPrefix === 'ja') {
                return 'jp';
            }
            
            // 預設返回英文
            return 'en';
        }
        
        // 客戶端路由處理
        function handleRoute() {
            const path = window.location.pathname;
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            // 根路徑處理 - 檢查是否有語言參數
            if (path === '/' || path === '/index.html') {
                if (langParam) {
                    // 支援的語言列表
                    const supportedLanguages = ['en', 'tw', 'cn', 'jp'];
                    
                    if (supportedLanguages.includes(langParam)) {
                        // 有效的語言參數，載入首頁
                        const newUrl = `index.html?lang=${langParam}`;
                        window.location.href = newUrl;
                    } else {
                        // 無效的語言參數，重定向到預設語言（繁體中文）
                        window.location.href = '/';
                    }
                } else {
                    // 沒有語言參數，自動檢測語言
                    const detectedLang = detectBrowserLanguage();
                    if (detectedLang === 'tw') {
                        // 預設語言（繁體中文）不需要參數
                        const newUrl = 'index.html';
                        window.location.href = newUrl;
                    } else {
                        // 其他語言需要參數
                        window.location.href = `/?lang=${detectedLang}`;
                    }
                }
                return;
            }
            
            // 文章URL匹配: /[category]/[title_slug]_[id]_[language]
            const articlePattern = /^\/([^\/]+)\/(.+)_(\d+)_([a-z]{2,3})\/?$/;
            const articleMatch = path.match(articlePattern);
            
            if (articleMatch) {
                const [, category, titleSlug, articleId, language] = articleMatch;
                
                // 重定向到article.html並保持新URL
                const newUrl = `article.html?id=${articleId}&lang=${language}`;
                
                // 使用history API保持URL不變
                history.replaceState(null, '', path);
                
                // 載入文章頁面內容
                window.location.href = newUrl;
            } else {
                // 如果不匹配任何模式，重定向到自動檢測語言的首頁
                const detectedLang = detectBrowserLanguage();
                if (detectedLang === 'tw') {
                    window.location.href = '/';
                } else {
                    window.location.href = `/?lang=${detectedLang}`;
                }
            }
        }
        
        // 頁面載入時執行路由處理
        window.addEventListener('load', handleRoute);
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px;">
        <h2>正在載入文章...</h2>
        <p>請稍候，系統正在處理您的請求。</p>
    </div>
</body>
</html>